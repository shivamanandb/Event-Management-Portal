<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - EventHub</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            line-height: 1.6;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 50px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-container img {
            margin-right: 10px;
        }

        .brand-name {
            font-size: 20px;
            font-weight: bold;
        }

        .tagline {
            color: #666;
            font-size: 12px;
        }

        nav a {
            margin-right: 15px;
            text-decoration: none;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 50px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .bookings-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .booking-card {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .booking-card:hover {
            transform: translateY(-5px);
        }

        .booking-image {
            width: 250px;
            flex-shrink: 0;
        }

        .booking-image img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .booking-details {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .booking-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-confirmed {
            background-color: #4CAF50;
            color: white;
        }

        .status-pending {
            background-color: #FFC107;
            color: white;
        }

        .status-cancelled {
            background-color: #F44336;
            color: white;
        }

        .booking-details h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .booking-meta {
            color: #666;
            margin-bottom: 15px;
        }

        .booking-actions {
            display: flex;
            gap: 10px;
        }

        .booking-btn {
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .view-details-btn {
            background-color: #4285f4;
            color: white;
        }

        .cancel-booking-btn {
            background-color: #ea4335;
            color: white;
        }

        .empty-bookings {
            text-align: center;
            padding: 50px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <header>
        <div class="logo-container">
            <div class="logo">
                <img src="/assets/homepage/event.png" height="40px" width="40px" alt="event" />
            </div>
            <div>
                <div class="brand-name">EventHub</div>
                <div class="tagline">Event Management Platform</div>
            </div>
        </div>
        <nav id="nav-links"></nav>
        <div id="auth-buttons"></div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>My Bookings</h1>
            <p>View and manage your event bookings</p>
        </div>

        <div id="bookingsList" class="bookings-list">
            <!-- Bookings will be dynamically inserted here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup navigation first
            setupNavigation();

            // Fetch user data and bookings
            const user = JSON.parse(localStorage.getItem('user'));

            if (!user) {
                // Redirect to login if no user is found
                window.location.href = 'homepage.html';
                return;
            }

            try {
                // Fetch bookings from backend
                const response = await fetch(`http://localhost:8080/bookings/all/${user.id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch bookings');
                }

                const bookings = await response.json();
                console.log("Bookingdss:: ", bookings)

                // Display bookings
                displayBookings(bookings);

                // Setup cancel booking functionality
                setupCancelBookingButtons(bookings);
            } catch (error) {
                console.error('Error fetching bookings:', error);
                const bookingsList = document.getElementById('bookingsList');
                bookingsList.innerHTML = `
            <div class="empty-bookings">
                <h2>Error Loading Bookings</h2>
                <p>Unable to retrieve your bookings. Please try again later.</p>
            </div>
        `;
            }

            // Setup additional event listeners
            setupEventListeners();
        });

        // Navigation setup function
        function setupNavigation() {
            const navLinks = document.getElementById('nav-links');
            const authButtons = document.getElementById('auth-buttons');

            if (!navLinks || !authButtons) {
                console.error("Required DOM elements not found");
                return;
            }

            // Clear existing content
            navLinks.innerHTML = `
        <a href="homepage.html">Home</a>
        <a href="events.html">Events</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="bookings.html">Your Bookings</a>
    `;

            // User profile dropdown
            const userProfileDiv = document.createElement('div');
            userProfileDiv.className = 'user-profile';
            userProfileDiv.innerHTML = `
        <div class="user-icon" onclick="toggleDropdown()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </div>
        <div class="dropdown-content" id="userDropdown">
            <a href="profile.html">View Profile</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    `;

            authButtons.appendChild(userProfileDiv);
        }

        /**
     * Converts a LocalDateTime to an ISO 8601 formatted string
     * @param {LocalDateTime} localDateTime - The LocalDateTime to convert
     * @returns {string} ISO 8601 formatted string
     */
        function localDateTimeToISOString(localDateTime) {
            // Ensure the input is a valid LocalDateTime object
            if (!(localDateTime instanceof Date)) {
                throw new Error('Input must be a Date object');
            }

            // Convert to ISO string 
            // toISOString() converts to UTC, so we'll use a custom method to preserve local time
            const year = localDateTime.getFullYear();
            const month = String(localDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(localDateTime.getDate()).padStart(2, '0');
            const hours = String(localDateTime.getHours()).padStart(2, '0');
            const minutes = String(localDateTime.getMinutes()).padStart(2, '0');
            const seconds = String(localDateTime.getSeconds()).padStart(2, '0');
            const milliseconds = String(localDateTime.getMilliseconds()).padStart(3, '0');

            // Format: YYYY-MM-DDTHH:mm:ss.sssZ
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.${milliseconds}Z`;
        }

        // Format date and time
        function formatDateTime(isoString) {
            if (!isoString) {
                return { date: 'Date TBD', time: 'Time TBD' };
            }

            try {
                const date = new Date(isoString);
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };

                return {
                    date: date.toLocaleDateString('en-US', dateOptions),
                    time: date.toLocaleTimeString('en-US', timeOptions)
                };
            } catch (error) {
                console.error("Error formatting date:", error);
                return { date: 'Invalid Date', time: 'Invalid Time' };
            }
        }

        // Display bookings
        function displayBookings(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            bookingsList.innerHTML = ''; // Clear existing bookings

            if (!bookings || bookings.length === 0) {
                bookingsList.innerHTML = `
            <div class="empty-bookings">
                <h2>No Bookings Found</h2>
                <p>You haven't booked any events yet. Explore and book some exciting events!</p>
            </div>
        `;
                return;
            }

            bookings.forEach(booking => {
                const event = JSON.parse(localStorage.getItem('events')).find(event => event.id == booking.eventId)

                console.log("event:", event)
                const eventDateTime = formatDateTime(event.eventDateTime);
                const ticketBookedDate = formatDateTime(event.bookingDateTime)
                const imagePath = '' || `/assets/events/event${Math.floor(Math.random() * 5) + 1}.jpg`;


                // Determine status color and text
                let statusClass = '';
                let statusText = '';
                switch (booking.bookingStatus) {
                    case true:
                        statusClass = 'status-confirmed';
                        statusText = 'Confirmed';
                        break;
                    case false:
                        statusClass = 'status-cancelled';
                        statusText = 'Cancelled';
                        break;
                    default:
                        statusClass = 'status-pending';
                        statusText = 'Unknown';
                }

                const bookingCard = document.createElement('div');
                bookingCard.className = 'booking-card';
                bookingCard.innerHTML = `
            <div class="booking-image">
                <img src="${imagePath}" alt="${event.title}">
            </div>
            <div class="booking-details">
                <div class="booking-header">
                    <h3>${event.title}</h3>
                    <span class="booking-status ${statusClass}">${statusText}</span>
                </div>
                <div class="booking-meta">
                    <b>Event Date And Time: </b><span>${eventDateTime.date} | ${eventDateTime.time}</span>
                    <div> 
                        <b>Ticket Booking Date And Time: </b><span>${ticketBookedDate.date} | ${ticketBookedDate.time}</span>
                    </div>
                    <p>Location: ${event.location || 'Location TBD'}</p>
                    <p>Tickets: ${booking.numberOfBookedSeats} seat(s)</p>
                </div>
                <div class="booking-actions">
                    <a href="/event-details.html?id=${event.id}" class="booking-btn view-details-btn">View Details</a>
                    ${booking.bookingStatus === true ?
                        `<a href="#" class="booking-btn cancel-booking-btn" data-id="${booking.id}">Cancel Booking</a>`
                        : ''
                    }
                </div>
            </div>
        `;

                bookingsList.appendChild(bookingCard);
            });
        }

        function setupCancelBookingButtons(bookings) {
            const cancelButtons = document.querySelectorAll('.cancel-booking-btn');
            cancelButtons.forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const bookingId = button.getAttribute('data-id');

                    // Use a more modern confirmation dialog
                    const confirmCancel = confirm("Are you sure you want to cancel this booking? This action cannot be undone.");

                    if (confirmCancel) {
                        try {
                            // Disable the button immediately and permanently
                            button.disabled = true;
                            button.textContent = 'Cancelling...';
                            button.style.opacity = '0.5';
                            button.classList.add('disabled');

                            // Send cancel booking request to backend
                            const response = await fetch(`http://localhost:8080/bookings/cancel/${bookingId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });

                            if (!response.ok) {
                                // Throw an error with more context
                                const errorBody = await response.text();
                                throw new Error(`Failed to cancel booking: ${errorBody}`);
                            }
                            const cancelledEventData = await response.json();
                            console.log("cancelled event data : ", cancelledEventData)

                            // update remaining seat into localStorage
                            let eventData = JSON.parse(localStorage.getItem('events'));
                            const currEventData = eventData.find((e)=> e.id == cancelledEventData.eventId)
                            console.log("Current Event Data : ", currEventData);
                            console.log("Cancelled Event Data : ", cancelledEventData);
                            currEventData.remainingSeat += cancelledEventData.numberOfBookedSeats;
                            localStorage.removeItem('events')
                            eventData = eventData.filter((e) => e.id != cancelledEventData.eventId)
                            eventData.push(currEventData)
                            localStorage.setItem('events', JSON.stringify(eventData))

                            // Refetch bookings to ensure most up-to-date data
                            const user = JSON.parse(localStorage.getItem('user'));
                            const refreshResponse = await fetch(`http://localhost:8080/bookings/all/${user.id}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });

                            if (!refreshResponse.ok) {
                                throw new Error('Failed to refresh bookings after cancellation');
                            }

                            const updatedBookings = await refreshResponse.json();
                            console.log("updated bookings: ", updatedBookings)

                            // Display updated bookings
                            displayBookings(updatedBookings);

                        } catch (error) {
                            console.error('Error cancelling booking:', error);

                            // Re-enable the button if there's an error
                            button.disabled = false;
                            button.textContent = 'Cancel Booking';
                            button.style.opacity = '1';
                            button.classList.remove('disabled');
                        }
                    }
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Dropdown and logout functions
            function toggleDropdown() {
                const dropdown = document.getElementById("userDropdown");
                if (dropdown) {
                    dropdown.classList.toggle("show");
                }
            }

            function logout() {
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = 'homepage.html';
            }

            // Close dropdown if clicked outside
            window.onclick = function (event) {
                if (!event.target.matches('.user-icon') &&
                    !event.target.matches('.user-icon svg') &&
                    !event.target.matches('.user-icon path') &&
                    !event.target.matches('.user-icon circle')) {

                    const dropdowns = document.getElementsByClassName("dropdown-content");
                    for (let i = 0; i < dropdowns.length; i++) {
                        const openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }
        }

    </script>
</body>

</html>